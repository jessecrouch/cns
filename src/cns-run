#!/bin/bash
# CNS Runner - Execute CNS files from the command line
# Usage: ./cns-run <file.cns>       (run verbose CNS)
#        ./cns-run <file.cnsc>      (run compact CNSC - auto-expands)
#        ./cns-run --all            (run all examples)
#        ./cns-run --list           (list available examples)

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CNS_LISP="$SCRIPT_DIR/cns.lisp"
CNS_EXPAND="$SCRIPT_DIR/cns-expand"

if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "CNS Runner - Execute Causal Narrative Script programs"
    echo ""
    echo "Usage:"
    echo "  ./cns-run <file.cns>                Run a verbose CNS file"
    echo "  ./cns-run <file.cnsc>               Run a compact CNSC file (auto-expands)"
    echo "  ./cns-run --max-iterations N file   Set max iterations (default: 10000)"
    echo "  ./cns-run --trace file              Enable trace mode (execution visibility)"
    echo "  ./cns-run --strict file             Enable strict mode (immediate NIL errors)"
    echo "  ./cns-run --all                     Run all example files"
    echo "  ./cns-run --list                    List available examples"
    echo "  ./cns-run --repl                    Start interactive REPL"
    echo "  ./cns-run --test                    Run test suite"
    echo ""
    echo "Flags can be combined: ./cns-run --trace --strict --max-iterations 1000 file.cns"
    echo "Both .cns and .cnsc formats are supported seamlessly."
    echo ""
    exit 0
fi

if [ "$1" = "--list" ] || [ "$1" = "-l" ]; then
    echo "Available CNS examples:"
    echo ""
    for file in examples/*.cns; do
        if [ -f "$file" ]; then
            filename=$(basename "$file")
            story=$(grep "^Story:" "$file" | sed 's/Story: //')
            printf "  %-20s %s\n" "$filename" "$story"
        fi
    done
    echo ""
    exit 0
fi

if [ "$1" = "--all" ] || [ "$1" = "-a" ]; then
    echo "Running all CNS examples..."
    echo "=========================================="
    for file in examples/*.cns; do
        if [ -f "$file" ]; then
            echo ""
            echo ">>> $(basename "$file")"
            sbcl --noinform --load "$CNS_LISP" --eval "(progn (format t \"~%\") (load-cns-file \"$file\"))" --quit 2>&1 | grep -v "^;"
            echo ""
        fi
    done
    exit 0
fi

if [ "$1" = "--repl" ] || [ "$1" = "-r" ]; then
    echo "Starting CNS REPL..."
    sbcl --load "$CNS_LISP" --eval "(cns-repl)"
    exit 0
fi

if [ "$1" = "--test" ] || [ "$1" = "-t" ]; then
    echo "Running CNS test suite..."
    cd "$SCRIPT_DIR/../tests/llm-tests"
    ./run-tests.sh
    exit $?
fi

# Parse flags
MAX_ITERS=""
TRACE_MODE=""
STRICT_MODE=""
FILE_ARG=""

while [ $# -gt 0 ]; do
    case "$1" in
        --max-iterations)
            if [ -z "$2" ]; then
                echo "Error: --max-iterations requires a number"
                exit 1
            fi
            MAX_ITERS="$2"
            shift 2
            ;;
        --trace)
            TRACE_MODE="t"
            shift
            ;;
        --strict)
            STRICT_MODE="t"
            shift
            ;;
        *)
            FILE_ARG="$1"
            shift
            ;;
    esac
done

if [ -z "$FILE_ARG" ]; then
    echo "Error: No file specified"
    echo "Usage: ./cns-run <file.cns> or <file.cnsc>"
    echo "       ./cns-run --max-iterations N <file.cns>"
    echo "       ./cns-run --help for more options"
    exit 1
fi

if [ ! -f "$FILE_ARG" ]; then
    echo "Error: File '$FILE_ARG' not found"
    exit 1
fi

# Build the SBCL command
SBCL_CMD="(progn "
if [ -n "$MAX_ITERS" ]; then
    SBCL_CMD+="(setf *max-iterations* $MAX_ITERS) "
fi
if [ -n "$TRACE_MODE" ]; then
    SBCL_CMD+="(setf *trace-mode* t) "
fi
if [ -n "$STRICT_MODE" ]; then
    SBCL_CMD+="(setf *strict-mode* t) "
fi

# Check if it's a CNSC file (compact format)
if [[ "$FILE_ARG" == *.cnsc ]]; then
    # Auto-expand CNSC to CNS, then execute
    TEMP_CNS=$(mktemp /tmp/cns-expanded.XXXXXX.cns)
    trap "rm -f $TEMP_CNS" EXIT
    
    "$CNS_EXPAND" "$FILE_ARG" > "$TEMP_CNS"
    if [ $? -ne 0 ]; then
        echo "Error: Failed to expand CNSC file '$FILE_ARG'"
        exit 1
    fi
    
    # Run the expanded CNS file
    SBCL_CMD+="(load-cns-file \"$TEMP_CNS\"))"
    sbcl --noinform --load "$CNS_LISP" --eval "$SBCL_CMD" --quit
else
    # Run the CNS file directly
    SBCL_CMD+="(load-cns-file \"$FILE_ARG\"))"
    sbcl --noinform --load "$CNS_LISP" --eval "$SBCL_CMD" --quit
fi
