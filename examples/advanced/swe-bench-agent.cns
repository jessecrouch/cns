Story: SWE-bench Multi-Language Agent
# Generic agent for running SWE-bench Multilingual tasks
# Supports Rust, Go, Java, JavaScript, Ruby, PHP, C, C++
# Usage: Modify TaskFile variable to point to any task JSON

Given:
  TaskFile: String = "test-repos/swebench-tasks/astral-sh__ruff-15309.json"
  TaskJSON: String = ""
  RepoURL: String = ""
  RepoName: String = ""
  BaseCommit: String = ""
  PatchCommit: String = ""
  TestPatch: String = ""
  WorkDir: String = "/tmp/swebench"
  Language: String = "unknown"
  TestCommand: String = ""
  CloneOutput: String = ""
  CheckoutOutput: String = ""
  TestOutput: String = ""
  ExitCode: Number = 0
  FileCount: Number = 0
  FailureCount: Number = 0
  
Step 1 → Load task from JSON file
  Because: Need to get repository URL and commit hash
  Effect: TaskJSON becomes READ FILE TaskFile
  Effect: Print "=== Task Loaded ==="
  Effect: Print "Task file: {TaskFile}"

Step 2 → Parse task details
  Because: Extract repo and commit info
  # TODO: Add JSON dot notation support, for now hardcode for testing
  # Should be: RepoURL becomes TaskJSON.repo
  # For astral-sh__ruff-15309:
  Then: RepoURL becomes "https://github.com/astral-sh/ruff"
  Then: RepoName becomes "astral-sh/ruff"
  Then: BaseCommit becomes "75a24bbc67aa31b825b6326cfb6e6afdf3ca90d5"
  Then: WorkDir becomes "/tmp/swebench-ruff"
  Effect: Print "Repository: {RepoURL}"
  Effect: Print "Base commit: {BaseCommit}"
  Effect: Print "Working directory: {WorkDir}"

Step 3 → Clone repository  
  Because: Need the codebase to work with
  Effect: Print "=== Cloning Repository ==="
  Effect: SHELL "rm -rf {WorkDir}" INTO CloneOutput
  # Use filter=blob:none to reduce clone size but get all commits
  Effect: SHELL "git clone --filter=blob:none {RepoURL} {WorkDir} 2>&1" INTO CloneOutput WITH EXIT_CODE ExitCode
  Effect: Print "Clone status: {ExitCode}"

Step 4 → Checkout base commit
  Because: Need to start from the state before the fix
  Effect: Print "=== Checking out base commit ==="
  # Use -f to force checkout, overwriting any local files
  Effect: SHELL "cd {WorkDir} && git checkout -f {BaseCommit} 2>&1" INTO CheckoutOutput WITH EXIT_CODE ExitCode
  Effect: Print "Checkout status: {ExitCode}"

Step 5 → Detect language
  Because: Need to know build/test commands
  Effect: Print "=== Detecting Language ==="
  # Check for language-specific files
  Effect: SHELL "test -f {WorkDir}/Cargo.toml && echo rust || test -f {WorkDir}/go.mod && echo go || test -f {WorkDir}/pom.xml && echo java || test -f {WorkDir}/package.json && echo javascript || test -f {WorkDir}/Gemfile && echo ruby || echo unknown" INTO Language
  # TODO: Add TRIM function to clean whitespace
  # Hardcode for now since SHELL output includes newlines
  Then: Language becomes "rust"
  Effect: Print "Language detected: {Language}"

Step 6 → Set test command based on language
  Because: Different languages use different test frameworks
  If: Language IS "rust"
    Then: TestCommand becomes "export PATH=$HOME/.cargo/bin:$PATH && cd {WorkDir} && cargo test 2>&1"
    Effect: Print "Test command: cargo test"
  Otherwise:
    If: Language IS "go"
      Then: TestCommand becomes "cd {WorkDir} && go test ./... 2>&1"
      Effect: Print "Test command: go test"
    Otherwise:
      If: Language IS "java"
        Then: TestCommand becomes "cd {WorkDir} && mvn test 2>&1"
        Effect: Print "Test command: mvn test"
      Otherwise:
        If: Language IS "javascript"
          Then: TestCommand becomes "cd {WorkDir} && npm test 2>&1"
          Effect: Print "Test command: npm test"
        Otherwise:
          Effect: Print "WARNING: Unknown language, skipping tests"

Step 7 → Find source files
  Because: Understand codebase structure
  Effect: Print "=== Finding Source Files ==="
  # Find files based on detected language
  If: Language IS "rust"
    Effect: FIND "*.rs" IN "{WorkDir}" INTO CloneOutput WITH COUNT FileCount
    Effect: Print "Rust files found: {FileCount}"
  Otherwise:
    If: Language IS "go"
      Effect: FIND "*.go" IN "{WorkDir}" INTO CloneOutput WITH COUNT FileCount
      Effect: Print "Go files found: {FileCount}"
    Otherwise:
      If: Language IS "java"
        Effect: FIND "*.java" IN "{WorkDir}" INTO CloneOutput WITH COUNT FileCount
        Effect: Print "Java files found: {FileCount}"
      Otherwise:
        If: Language IS "javascript"
          Effect: FIND "*.js" IN "{WorkDir}" INTO CloneOutput WITH COUNT FileCount
          Effect: Print "JavaScript files found: {FileCount}"
        Otherwise:
          Effect: Print "No source files counted (unknown language)"

Step 8 → Run baseline tests (with timeout)
  Because: See what fails before we fix anything
  Effect: Print "=== Running Baseline Tests ==="
  Effect: Print "NOTE: This may take several minutes for large projects..."
  Effect: Print "Command: {TestCommand}"
  # Run tests with timeout (2 minutes for quick validation)
  # In production, we'd run the full suite or specific failing tests
  Effect: SHELL "{TestCommand} | head -200" INTO TestOutput WITH EXIT_CODE ExitCode
  Effect: Print "Test exit code: {ExitCode}"
  Effect: Print "Test output (first 200 lines):"
  Effect: Print "{TestOutput}"

Step 9 → Summary
  Because: Report what we accomplished
  Effect: Print "=== Workflow Complete ==="
  Effect: Print "Task: {TaskFile}"
  Effect: Print "Repository: {RepoName}"
  Effect: Print "Commit: {BaseCommit}"
  Effect: Print "Language: {Language}"
  Effect: Print "Files found: {FileCount}"
  Effect: Print "Test exit code: {ExitCode}"
  Effect: Print ""
  Effect: Print "Next steps:"
  Effect: Print "1. Analyze test failures in output above"
  Effect: Print "2. Identify failing test cases"
  Effect: Print "3. Use GREP/FIND to locate relevant source code"
  Effect: Print "4. Generate patch to fix the issue"
  Effect: Print "5. Apply patch and re-run tests"
  
End: ExitCode
